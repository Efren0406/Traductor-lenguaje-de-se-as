<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandSpeak AI</title>
    
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bienvenido a <span>HandSpeak</span></h1>
        </div>
        <div class="content">
            <div class="traduccion">
                <p id="translation">Su traducción se verá aquí</p>
            </div>
            <div class="main-content">
                <video id="video" width="640" height="480" autoplay></video>
                <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
                <br>   
                <div class="sidebar">
                    <button>Traducir</button>
                    <button data-toggle="modal" data-target="#helpModal">Ayuda</button>
                    <button>Exportar</button>
                </div>
                <script>
                    const video = document.getElementById('video');
                    const canvas = document.getElementById('canvas');
                    const context = canvas.getContext('2d');
                    const translationText = document.getElementById('translation');

                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(stream => {
                            video.srcObject = stream;
                            processFrame();
                        })
                        .catch(err => {
                            console.error("Ocurrió un error: " + err);
                        });

                    function processFrame() {
                        context.drawImage(video, 0, 0, 640, 480);
                        const dataUrl = canvas.toDataURL('image/png');
                        console.log("Sending image to backend");
                        fetch('/upload/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: 'image=' + encodeURIComponent(dataUrl)
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Response from backend:", data);
                            if (data.status === 'ok') {
                                const translation = data.translation ? data.translation : 'No se detectó ningún gesto';
                                translationText.textContent = translation;
                                if (data.translation) {
                                    speak(translation);
                                }
                            }
                            requestAnimationFrame(processFrame);
                        })
                        .catch(error => {
                            console.error("Error al procesar el fotograma: ", error);
                            requestAnimationFrame(processFrame);
                        });
                    }

                    function speak(text) {
                        const msg = new SpeechSynthesisUtterance();
                        msg.text = text;
                        msg.lang = 'es-ES';
                        window.speechSynthesis.speak(msg);
                    }
                </script>
                <br>    
                <button class="conocenos-button">Conocenos</button>
            </div>
        </div>
        <div class="footer">
            HandSpeak AI
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Ayuda</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="helpCarousel" class="carousel slide" data-ride="carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <img src="{% static 'img/banner1.gif' %}" class="d-block w-100" alt="Slide 1">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5>Slide 1</h5>
                                    <p>Descripción del primer slide.</p>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <img src="{% static 'img/img2.jpg' %}" class="d-block w-100" alt="Slide 2">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5>Slide 2</h5>
                                    <p>Descripción del segundo slide.</p>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <img src="{% static 'im/img3.jpg' %}" class="d-block w-100" alt="Slide 3">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5>Slide 3</h5>
                                    <p>Descripción del tercer slide.</p>
                                </div>
                            </div>
                        </div>
                        <a class="carousel-control-prev" href="#helpCarousel" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Anterior</span>
                        </a>
                        <a class="carousel-control-next" href="#helpCarousel" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Siguiente</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
